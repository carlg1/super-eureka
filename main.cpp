/////////////////////////////////////////////////////////////////////////////////
// #includes
/////////////////////////////////////////////////////////////////////////////////
#include <iostream>
#include <unistd.h>

#include "config.h"
#include "udpsrv.h"


/////////////////////////////////////////////////////////////////////////////////
// namespaces
/////////////////////////////////////////////////////////////////////////////////
using namespace std;


/////////////////////////////////////////////////////////////////////////////////
// Enums
/////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////
// Structs
/////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////
// Classes
/////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////
// Global Vars
/////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////
// Funcation Prototypes
/////////////////////////////////////////////////////////////////////////////////
static bool Initilaize();


/////////////////////////////////////////////////////////////////////////////////
// Local Vars
/////////////////////////////////////////////////////////////////////////////////
tbdFlowConfig tbdconf;
UDPServer *srv;
EPoller epoller;


/////////////////////////////////////////////////////////////////////////////////
// main()
/////////////////////////////////////////////////////////////////////////////////
int main(int argc, char *argv[])
{
	EPoller::epoller_rv eprv;

	if(!tbdconf.ParseCmdArgs(argc, argv))
	{
		cout << "ParseCmdArgs Failed!" << endl;
		exit(1);
	}

	if(!Initilaize())
	{
		cerr << "Initilaize Failed!" << endl;
		exit(1);
	}

	cout << "Starting Main Loop!" << endl;
	while(tbdconf.Running())
	{
		eprv = epoller.Poll();
		if(eprv == EPoller::EPOLLER_DATA)
		{
			//epoller.Process
			////loop through results
			//char data[100];
			//int len = srv->GetData(data, 100);
			//data[len] = '\0';
			//cout << "Read # " << len << " of bytes! Data = '" << data << "'" << endl; 
		}
		else if(eprv == EPoller::EPOLLER_NODATA)
			usleep(100);
		else
			break;
	}

	delete srv;

	return 0;
}


/////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////
// Local Funtions
/////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////
// Initilaize
/////////////////////////////////////////////////////////////////////////////////
bool Initilaize()
{
	if(!tbdconf.ParseConfigFile())
		return false;

	if(tbdconf.GetPort() == 0)
	{
		cerr << "No port defined" << endl;
		return false;
	}

	srv = new UDPServer(tbdconf.GetPort());
	srv->StartServer();

	return true;
}
